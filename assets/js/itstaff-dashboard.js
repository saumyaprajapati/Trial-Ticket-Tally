if(!requireAuth()){}const user=getCurrentUser();if(!user||user.role!=='itstaff'){alert('Access denied');redirectToDashboard();}
document.addEventListener('DOMContentLoaded',function(){initializeDashboard();loadTickets();setupEventListeners();});
function initializeDashboard(){document.getElementById('userName').textContent=user.name;document.getElementById('welcomeMessage').textContent=`Welcome Back, ${user.name.split(' ')[0]}!`;const initials=user.name.split(' ').map(n=>n[0]).join('').toUpperCase();document.getElementById('userAvatar').textContent=initials;const options={weekday:'long',year:'numeric',month:'long',day:'numeric'};document.getElementById('currentDate').textContent=new Date().toLocaleDateString('en-US',options);}
function setupEventListeners(){document.getElementById('updateTicketForm').addEventListener('submit',handleUpdateTicket);document.getElementById('searchTickets').addEventListener('input',handleSearch);}
function getTickets(){const str=localStorage.getItem('ticket-tally-tickets');return str?JSON.parse(str):[];}
function saveTickets(tickets){localStorage.setItem('ticket-tally-tickets',JSON.stringify(tickets));}
function getAssignedTickets(){const all=getTickets();const sevenDaysAgo=new Date();sevenDaysAgo.setDate(sevenDaysAgo.getDate()-7);return all.filter(t=>{if(!t.assignedTo||!t.assignedTo.includes('Team'))return false;if(t.status==='Closed'){const closed=new Date(t.closedAt);if(closed<sevenDaysAgo)return false;}return true;});}
function loadTickets(){const tickets=getAssignedTickets();updateKPIs(tickets);displayTickets(tickets);}
function updateKPIs(tickets){const assigned=tickets.filter(t=>t.status!=='Closed').length;const inProgress=tickets.filter(t=>t.status==='In Progress').length;const today=new Date().toDateString();const resolved=tickets.filter(t=>t.status==='Resolved'&&new Date(t.resolvedAt||t.createdAt).toDateString()===today).length;const sla=tickets.filter(t=>{const created=new Date(t.createdAt);const hoursSince=(new Date()-created)/3600000;return t.status!=='Resolved'&&t.status!=='Closed'&&((t.priority==='Critical'&&hoursSince>4)||(t.priority==='High'&&hoursSince>8))}).length;document.getElementById('assignedTickets').textContent=assigned;document.getElementById('inProgressTickets').textContent=inProgress;document.getElementById('resolvedTickets').textContent=resolved;document.getElementById('slaBreaches').textContent=sla;}
function displayTickets(tickets){const tbody=document.getElementById('ticketsTableBody');if(tickets.length===0){tbody.innerHTML='<tr><td colspan="8" class="text-center py-5"><div class="text-muted"><i class="fas fa-inbox fa-3x mb-3"></i><p>No tickets assigned</p></div></td></tr>';return;}const priorityOrder={'Critical':4,'High':3,'Medium':2,'Low':1};tickets.sort((a,b)=>{const diff=priorityOrder[b.priority]-priorityOrder[a.priority];return diff!==0?diff:new Date(b.createdAt)-new Date(a.createdAt);});tbody.innerHTML=tickets.map(t=>`<tr><td><strong>${t.id}</strong></td><td>${t.subject}</td><td><span class="badge bg-secondary">${t.category}</span></td><td><span class="priority-badge priority-${t.priority.toLowerCase()}">${t.priority}</span></td><td>${t.createdByName||'Unknown'}</td><td><span class="status-badge status-${t.status.toLowerCase().replace(' ','-')}">${t.status}</span></td><td>${timeAgo(t.createdAt)}</td><td><button class="btn btn-sm btn-primary-custom" onclick="showUpdateModal('${t.id}')"><i class="fas fa-edit me-1"></i>Update</button></td></tr>`).join('');}
function filterTickets(status){const tickets=getAssignedTickets();const filtered=status==='all'?tickets:tickets.filter(t=>t.status===status);displayTickets(filtered);document.querySelectorAll('.nav-link-item').forEach(link=>{link.classList.remove('active');});if(event&&event.target){const clickedLink=event.target.closest('.nav-link-item');if(clickedLink){clickedLink.classList.add('active');}}}
function handleSearch(e){const term=e.target.value.toLowerCase();const tickets=getAssignedTickets();const filtered=tickets.filter(t=>t.id.toLowerCase().includes(term)||t.subject.toLowerCase().includes(term)||t.createdByName.toLowerCase().includes(term));displayTickets(filtered);}
function showUpdateModal(ticketId){const tickets=getTickets();const ticket=tickets.find(t=>t.id===ticketId);if(!ticket)return;document.getElementById('updateTicketId').value=ticketId;document.getElementById('updateTicketTitle').textContent=`Update ${ticketId}`;document.getElementById('updateStatus').value=ticket.status==='Open'?'In Progress':ticket.status;const modal=new bootstrap.Modal(document.getElementById('updateTicketModal'));modal.show();}
function handleUpdateTicket(e){e.preventDefault();const ticketId=document.getElementById('updateTicketId').value;const newStatus=document.getElementById('updateStatus').value;const note=document.getElementById('updateNote').value;const tickets=getTickets();const idx=tickets.findIndex(t=>t.id===ticketId);if(idx===-1)return;tickets[idx].status=newStatus;if(newStatus==='Resolved')tickets[idx].resolvedAt=new Date().toISOString();tickets[idx].timeline.push({action:`Status changed to ${newStatus}`,by:`${user.name} (IT Staff)`,timestamp:new Date().toISOString(),note:note||undefined});saveTickets(tickets);const modal=bootstrap.Modal.getInstance(document.getElementById('updateTicketModal'));modal.hide();document.getElementById('updateTicketForm').reset();loadTickets();alert(`Ticket ${ticketId} updated to ${newStatus}`);}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('active');document.getElementById('sidebarOverlay').classList.toggle('active');}